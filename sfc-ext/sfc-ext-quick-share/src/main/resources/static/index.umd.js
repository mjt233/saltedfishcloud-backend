(function(n,e){typeof exports=="object"&&typeof module<"u"?e(require("sfc-common"),require("vue")):typeof define=="function"&&define.amd?define(["sfc-common","vue"],e):(n=typeof globalThis<"u"?globalThis:n||self,e(n.SfcCommon,n.Vue))})(this,function(n,e){"use strict";const r={prefix:"/quickShare",feature:{isEnabled:"isEnabled",maxSize:"maxSize",effectiveDuration:"effectiveDuration"},featurePrefix:"quickshare",upload(p,o){const i=new FormData;return i.set("file",p),{url:`${this.prefix}/upload`,params:o,data:i,method:"post"}},getByCode(p){return{url:`${this.prefix}/getByCode`,params:{code:p}}},getShareFile(p){return{url:`${this.prefix}/getShareFile?id=${p}`}}},F={style:{width:"100%","max-width":"810px",margin:"0 auto",padding:"12px"}},U={style:{padding:"12px"}},q={class:"tip"},T={style:{padding:"12px"}},I=e.defineComponent({name:"QuickShareView",components:{CommonIcon:n.Components.CommonIcon}}),_=e.defineComponent({...I,props:{},setup(p){const o=window.SfcUtils,i=e.ref("1"),m=e.ref(""),x=e.ref(""),g=e.ref([]),w=e.ref(""),h=e.ref(),N=e.ref(),y=e.ref(),S=(o.getSystemFeature(r.featurePrefix,r.feature.maxSize)||512)*1024*1024,C={sendCode:[n.Validators.maxLen(null,20),n.Validators.minLen(null,1)],extractCode:[n.Validators.notNull()],file:[n.Validators.requireFile(),n.Validators.fileMaxSize(S)],message:[n.Validators.maxLen(null,255)]},b=async()=>{y.value.blur();const d=await N.value.validate();if(!d.valid){o.snackbar("校验失败:"+d.errors.map(a=>a.errorMessages).join(";"));return}const t=o.loadingDialog({msg:"正在获取分享信息"});try{const s=(await o.request(r.getByCode(m.value))).data.data;s.message?o.alert(s.message,"提取成功 - 留言").then(()=>o.openApiUrl(r.getShareFile(s.id))):o.openApiUrl(r.getShareFile(s.id))}catch(a){console.error(a),await o.alert("获取错误: "+a),y.value.focus()}finally{t.close()}},P=async()=>{const d=await h.value.validate();if(!d.valid){o.snackbar("校验失败:"+d.errors.map(c=>c.errorMessages).join(";"));return}const t=e.reactive({msg:"上传中"}),a=o.loadingDialog(t),s=r.upload(g.value[0],{code:x.value,message:w.value});s.onUploadProgress=c=>{t.msg="上传中..."+(c.loaded/c.total*100).toFixed(2)+"%"};try{const f=(await o.request(s)).data.data;let u="你的提取码为："+f;f!=x.value&&(u+="(提取码冲突，系统随机新生成)");const V=n.StringUtils.appendPath(location.origin,"/#/box/quick-share?code="+encodeURIComponent(f));o.openComponentDialog(e.h("div",null,[e.h("div",null,u),e.h("div",null,[e.h("span",null,"提取链接："),e.h("a",{class:"link",onClick:()=>{o.copyToClipboard(V),o.snackbar("复制成功")}},V)]),e.h("div",null,"或通过【百宝箱 - 文件极速传】功能中直接输入提取码提取")]),{showCancel:!1,title:"发送成功"})}catch(c){o.alert("发送失败: "+c),console.error(c)}finally{a.close()}},D=async()=>{var t;const d=(t=n.getContext().routeInfo.value.curr)==null?void 0:t.query;d&&d.code&&(m.value=decodeURIComponent(d.code))};return e.onMounted(()=>{D()}),(d,t)=>{const a=e.resolveComponent("CommonIcon"),s=e.resolveComponent("v-tab"),c=e.resolveComponent("v-tabs"),f=e.resolveComponent("v-text-field"),u=e.resolveComponent("VBtn"),V=e.resolveComponent("VForm"),k=e.resolveComponent("VWindowItem"),z=e.resolveComponent("v-file-input"),E=e.resolveComponent("VTextarea"),B=e.resolveComponent("VWindow"),R=e.resolveComponent("VCardText"),A=e.resolveComponent("VCard");return e.openBlock(),e.createElementBlock("div",F,[e.createVNode(A,{title:"文件极速传"},{default:e.withCtx(()=>[e.createVNode(c,{modelValue:i.value,"onUpdate:modelValue":t[0]||(t[0]=l=>i.value=l),color:"primary"},{default:e.withCtx(()=>[e.createVNode(s,{value:"1"},{default:e.withCtx(()=>[e.createVNode(a,{icon:"mdi-folder-download"}),t[8]||(t[8]=e.createTextVNode(" 接收文件 "))]),_:1}),e.createVNode(s,{value:"2"},{default:e.withCtx(()=>[e.createVNode(a,{icon:"mdi-send"}),t[9]||(t[9]=e.createTextVNode(" 发送文件 "))]),_:1})]),_:1},8,["modelValue"]),e.createVNode(R,null,{default:e.withCtx(()=>[e.createVNode(B,{modelValue:i.value,"onUpdate:modelValue":t[7]||(t[7]=l=>i.value=l)},{default:e.withCtx(()=>[e.createVNode(k,{value:"1"},{default:e.withCtx(()=>[e.createVNode(V,{ref_key:"extractFormRef",ref:N,onSubmit:t[2]||(t[2]=e.withModifiers(()=>{},["prevent"]))},{default:e.withCtx(()=>[e.createElementVNode("div",U,[e.createVNode(f,{ref_key:"extractInput",ref:y,modelValue:m.value,"onUpdate:modelValue":t[1]||(t[1]=l=>m.value=l),clearable:"",label:"请输入文件提取码",color:"primary",rules:C.extractCode,variant:"underlined",onKeyup:e.withKeys(b,["enter"])},null,8,["modelValue","rules"]),e.createVNode(u,{color:"primary",style:{display:"block",width:"100%"},onClick:b},{default:e.withCtx(()=>t[10]||(t[10]=[e.createTextVNode(" 提取 ")])),_:1})])]),_:1},512)]),_:1}),e.createVNode(k,{value:"2"},{default:e.withCtx(()=>[e.createVNode(V,{ref_key:"sendFormRef",ref:h,onSubmit:t[6]||(t[6]=e.withModifiers(()=>{},["prevent"]))},{default:e.withCtx(()=>[e.createElementVNode("div",q,[e.createTextVNode(" 文件保留时长："+e.toDisplayString(e.unref(o).getSystemFeature(e.unref(r).featurePrefix,e.unref(r).feature.effectiveDuration)||30)+"分钟",1),t[11]||(t[11]=e.createElementVNode("br",null,null,-1)),e.createTextVNode(" 文件大小限制："+e.toDisplayString(e.unref(n.StringFormatter).toSize(S)),1)]),e.createElementVNode("div",T,[e.createVNode(z,{modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=l=>g.value=l),label:"请选择文件",rules:C.file,variant:"underlined"},null,8,["modelValue","rules"]),e.createVNode(f,{modelValue:x.value,"onUpdate:modelValue":t[4]||(t[4]=l=>x.value=l),clearable:"",label:"请输入文件提取码",color:"primary",rules:C.sendCode,variant:"underlined"},null,8,["modelValue","rules"]),e.createVNode(E,{modelValue:w.value,"onUpdate:modelValue":t[5]||(t[5]=l=>w.value=l),style:{"margin-top":"12px"},rules:C.message,label:"留言",color:"primary",variant:"outlined"},null,8,["modelValue","rules"]),e.createVNode(u,{color:"primary",style:{display:"block",width:"100%"},onClick:P},{default:e.withCtx(()=>[e.createVNode(a,{icon:"mdi-send"}),t[12]||(t[12]=e.createTextVNode(" 发送，走你~ "))]),_:1})])]),_:1},512)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})])}}}),M=window.SfcUtils;window.bootContext.addProcessor({taskName:"注册组件 - 文件快速传",execute(p){if(!M.getSystemFeature(r.featurePrefix,r.feature.isEnabled))return;p.component(_.name,_);const o=n.getContext().menu.value.boxMenu.find(m=>m.id=="shareAndCollection"),i={id:"quick-share",icon:"mdi-flash",title:"文件极速传",action(m){m.title="文件极速传",m.currentComponent="quick-share-view"}};o?o.items.push(i):n.getContext().menu.value.boxMenu.push({id:"shareAndCollection",name:"文件交流",items:[i]})}})});
