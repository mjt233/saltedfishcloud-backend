(function(t,$){typeof exports=="object"&&typeof module<"u"?$(require("vue"),require("sfc-common")):typeof define=="function"&&define.amd?define(["vue","sfc-common"],$):(t=typeof globalThis<"u"?globalThis:t||self,$(t.Vue,t.SfcCommon))})(this,function(t,$){"use strict";function Ke(e){var n=e.toLowerCase().trim().split(/\s*;\s*/);return n[0]==="banner"?{name:n[0],delay:n[1]*1||0,leftToRight:n[2]*1||0,fadeAwayWidth:n[3]*1||0}:/^scroll\s/.test(n[0])?{name:n[0],y1:Math.min(n[1]*1,n[2]*1),y2:Math.max(n[1]*1,n[2]*1),delay:n[3]*1||0,fadeAwayHeight:n[4]*1||0}:null}function pe(e){return e.toLowerCase().replace(/([+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?)/g," $1 ").replace(/([mnlbspc])/g," $1 ").trim().replace(/\s+/g," ").split(/\s(?=[mnlbspc])/).map(function(n){return n.split(" ").filter(function(a,r){return!(r&&Number.isNaN(a*1))})})}var Ze=["b","i","u","s","fsp","k","K","kf","ko","kt","fe","q","p","pbo","a","an","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"],Ne=Ze.map(function(e){return{name:e,regex:new RegExp("^"+e+"-?\\d")}});function Ee(e){for(var n,a={},r=0;r<Ne.length;r++){var i=Ne[r],s=i.name,o=i.regex;if(o.test(e))return a[s]=e.slice(s.length)*1,a}if(/^fn/.test(e))a.fn=e.slice(2);else if(/^r/.test(e))a.r=e.slice(1);else if(/^fs[\d+-]/.test(e))a.fs=e.slice(2);else if(/^\d?c&?H?[0-9a-f]+|^\d?c$/i.test(e)){var l=e.match(/^(\d?)c&?H?(\w*)/),c=l[1],f=l[2];a["c"+(c||1)]=f&&("000000"+f).slice(-6)}else if(/^\da&?H?[0-9a-f]+/i.test(e)){var d=e.match(/^(\d)a&?H?(\w\w)/),m=d[1],g=d[2];a["a"+m]=g}else if(/^alpha&?H?[0-9a-f]+/i.test(e))n=e.match(/^alpha&?H?([0-9a-f]+)/i),a.alpha=n[1],a.alpha=("00"+a.alpha).slice(-2);else if(/^(?:pos|org|move|fad|fade)\(/.test(e)){var p=e.match(/^(\w+)\((.*?)\)?$/),v=p[1],b=p[2];a[v]=b.trim().split(/\s*,\s*/).map(Number)}else if(/^i?clip/.test(e)){var y=e.match(/^i?clip\((.*?)\)?$/)[1].trim().split(/\s*,\s*/);a.clip={inverse:/iclip/.test(e),scale:1,drawing:null,dots:null},y.length===1&&(a.clip.drawing=pe(y[0])),y.length===2&&(a.clip.scale=y[0]*1,a.clip.drawing=pe(y[1])),y.length===4&&(a.clip.dots=y.map(Number))}else if(/^t\(/.test(e)){var h=e.match(/^t\((.*?)\)?$/)[1].trim().replace(/\\.*/,function(S){return S.replace(/,/g,`
`)}).split(/\s*,\s*/);if(!h[0])return a;a.t={t1:0,t2:0,accel:1,tags:h[h.length-1].replace(/\n/g,",").split("\\").slice(1).map(Ee)},h.length===2&&(a.t.accel=h[0]*1),h.length===3&&(a.t.t1=h[0]*1,a.t.t2=h[1]*1),h.length===4&&(a.t.t1=h[0]*1,a.t.t2=h[1]*1,a.t.accel=h[2]*1)}return a}function Je(e){for(var n=[],a=0,r="",i=0;i<e.length;i++){var s=e[i];s==="("&&a++,s===")"&&a--,a<0&&(a=0),!a&&s==="\\"?(r&&n.push(r),r=""):r+=s}return n.push(r),n.map(Ee)}function Qe(e){var n=e.split(/{([^{}]*?)}/),a=[];n[0].length&&a.push({tags:[],text:n[0],drawing:[]});for(var r=1;r<n.length;r+=2){var i=Je(n[r]),s=i.reduce(function(o,l){return l.p===void 0?o:!!l.p},!1);a.push({tags:i,text:s?"":n[r+1],drawing:s?pe(n[r+1]):[]})}return{raw:e,combined:a.map(function(o){return o.text}).join(""),parsed:a}}function et(e){var n=e.split(":");return n[0]*3600+n[1]*60+n[2]*1}function tt(e,n){var a=e.split(",");if(a.length>n.length){var r=a.slice(n.length-1).join();a=a.slice(0,n.length-1),a.push(r)}for(var i={},s=0;s<a.length;s++){var o=n[s],l=a[s].trim();switch(o){case"Layer":case"MarginL":case"MarginR":case"MarginV":i[o]=l*1;break;case"Start":case"End":i[o]=et(l);break;case"Effect":i[o]=Ke(l);break;case"Text":i[o]=Qe(l);break;default:i[o]=l}}return i}function Ve(e){return e.match(/Format\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function nt(e){return e.match(/Style\s*:\s*(.*)/i)[1].split(/\s*,\s*/)}function at(e){for(var n={info:{},styles:{format:[],style:[]},events:{format:[],comment:[],dialogue:[]}},a=e.split(/\r?\n/),r=0,i=0;i<a.length;i++){var s=a[i].trim();if(!/^;/.test(s)&&(/^\[Script Info\]/i.test(s)?r=1:/^\[V4\+? Styles\]/i.test(s)?r=2:/^\[Events\]/i.test(s)?r=3:/^\[.*\]/.test(s)&&(r=0),r!==0)){if(r===1&&/:/.test(s)){var o=s.match(/(.*?)\s*:\s*(.*)/),l=o[1],c=o[2];n.info[l]=c}if(r===2&&(/^Format\s*:/i.test(s)&&(n.styles.format=Ve(s)),/^Style\s*:/i.test(s)&&n.styles.style.push(nt(s))),r===3&&(/^Format\s*:/i.test(s)&&(n.events.format=Ve(s)),/^(?:Comment|Dialogue)\s*:/i.test(s))){var f=s.match(/^(\w+?)\s*:\s*(.*)/i),d=f[1],m=f[2];n.events[d.toLowerCase()].push(tt(m,n.events.format))}}}return n}var B=Object.assign||function(n){for(var a=[],r=arguments.length-1;r-- >0;)a[r]=arguments[r+1];for(var i=0;i<a.length;i++)if(a[i])for(var s=Object.keys(a[i]),o=0;o<s.length;o++)n[s[o]]=a[i][s[o]];return n};function rt(e){var n={type:null,prev:null,next:null,points:[]};/[mnlbs]/.test(e[0])&&(n.type=e[0].toUpperCase().replace("N","L").replace("B","C"));for(var a=e.length-!(e.length&1),r=1;r<a;r+=2)n.points.push({x:e[r]*1,y:e[r+1]*1});return n}function ot(e){return!(!e.points.length||!e.type||/C|S/.test(e.type)&&e.points.length<3)}function it(e){var n,a=1/0,r=1/0,i=-1/0,s=-1/0;return(n=[]).concat.apply(n,e.map(function(o){var l=o.points;return l})).forEach(function(o){var l=o.x,c=o.y;a=Math.min(a,l),r=Math.min(r,c),i=Math.max(i,l),s=Math.max(s,c)}),{minX:a,minY:r,width:i-a,height:s-r}}function st(e,n,a){var r=[],i=[0,.6666666666666666,.3333333333333333,0],s=[0,1/3,2/3,0],o=[0,1/6,2/3,1/6],l=function(g,p){return g[0]*p[0]+g[1]*p[1]+g[2]*p[2]+g[3]*p[3]},c=[e[e.length-1].x,e[0].x,e[1].x,e[2].x],f=[e[e.length-1].y,e[0].y,e[1].y,e[2].y];r.push({type:n==="M"?"M":"L",points:[{x:l(o,c),y:l(o,f)}]});for(var d=3;d<e.length;d++)c=[e[d-3].x,e[d-2].x,e[d-1].x,e[d].x],f=[e[d-3].y,e[d-2].y,e[d-1].y,e[d].y],r.push({type:"C",points:[{x:l(i,c),y:l(i,f)},{x:l(s,c),y:l(s,f)},{x:l(o,c),y:l(o,f)}]});if(a==="L"||a==="C"){var m=e[e.length-1];r.push({type:"L",points:[{x:m.x,y:m.y}]})}return r}function lt(e){return e.map(function(n){var a=n.type,r=n.points;return a+r.map(function(i){var s=i.x,o=i.y;return s+","+o}).join(",")}).join("")}function _e(e){for(var n,a=[],r=0;r<e.length;){var i=e[r],s=rt(i);if(ot(s)){if(s.type==="S"){var o=(a[r-1]||{points:[{x:0,y:0}]}).points.slice(-1)[0],l=o.x,c=o.y;s.points.unshift({x:l,y:c})}r&&(s.prev=a[r-1].type,a[r-1].next=s.type),a.push(s),r++}else{if(r&&a[r-1].type==="S"){var f={p:s.points,c:a[r-1].points.slice(0,3)};a[r-1].points=a[r-1].points.concat((f[i[0]]||[]).map(function(m){var g=m.x,p=m.y;return{x:g,y:p}}))}e.splice(r,1)}}var d=(n=[]).concat.apply(n,a.map(function(m){var g=m.type,p=m.points,v=m.prev,b=m.next;return g==="S"?st(p,v,b):{type:g,points:p}}));return B({instructions:d,d:lt(d)},it(a))}var ct=["fs","clip","c1","c2","c3","c4","a1","a2","a3","a4","alpha","fscx","fscy","fax","fay","frx","fry","frz","fr","be","blur","bord","xbord","ybord","shad","xshad","yshad"];function U(e,n,a){var r,i,s;a===void 0&&(a={});var o=e[n];if(o===void 0)return null;if(n==="pos"||n==="org")return o.length===2?(r={},r[n]={x:o[0],y:o[1]},r):null;if(n==="move"){var l=o[0],c=o[1],f=o[2],d=o[3],m=o[4];m===void 0&&(m=0);var g=o[5];return g===void 0&&(g=0),o.length===4||o.length===6?{move:{x1:l,y1:c,x2:f,y2:d,t1:m,t2:g}}:null}if(n==="fad"||n==="fade"){if(o.length===2){var p=o[0],v=o[1];return{fade:{type:"fad",t1:p,t2:v}}}if(o.length===7){var b=o[0],y=o[1],h=o[2],S=o[3],V=o[4],u=o[5],w=o[6];return{fade:{type:"fade",a1:b,a2:y,a3:h,t1:S,t2:V,t3:u,t4:w}}}return null}if(n==="clip"){var x=o.inverse,N=o.scale,k=o.drawing,C=o.dots;if(k)return{clip:{inverse:x,scale:N,drawing:_e(k),dots:C}};if(C){var I=C[0],L=C[1],G=C[2],j=C[3];return{clip:{inverse:x,scale:N,drawing:k,dots:{x1:I,y1:L,x2:G,y2:j}}}}return null}if(/^[xy]?(bord|shad)$/.test(n)&&(o=Math.max(o,0)),n==="bord")return{xbord:o,ybord:o};if(n==="shad")return{xshad:o,yshad:o};if(/^c\d$/.test(n))return i={},i[n]=o||a[n],i;if(n==="alpha")return{a1:o,a2:o,a3:o,a4:o};if(n==="fr")return{frz:o};if(n==="fs")return{fs:/^\+|-/.test(o)?(o*1>-10?1+o/10:1)*a.fs:o*1};if(n==="t"){var X=o.t1,re=o.accel,oe=o.tags,K=o.t2||(a.end-a.start)*1e3,q={};return oe.forEach(function(Z){var H=Object.keys(Z)[0];~ct.indexOf(H)&&!(H==="clip"&&!Z[H].dots)&&B(q,U(Z,H,a))}),{t:{t1:X,t2:K,accel:re,tag:q}}}return s={},s[n]=o,s}var dt=[null,1,2,3,null,7,8,9,null,4,5,6],ft=["r","a","an","pos","org","move","fade","fad","clip"];function Be(e,n){return{name:e,borderStyle:n[e].style.BorderStyle,tag:n[e].tag,fragments:[]}}function pt(e){for(var n=e.styles,a=e.name,r=e.parsed,i=e.start,s=e.end,o,l,c,f,d,m,g=[],p=Be(a,n),v={},b=0;b<r.length;b++){for(var y=r[b],h=y.tags,S=y.text,V=y.drawing,u=void 0,w=0;w<h.length;w++){var x=h[w];u=x.r===void 0?u:x.r}for(var N={tag:u===void 0?JSON.parse(JSON.stringify(v)):{},text:S,drawing:V.length?_e(V):null},k=0;k<h.length;k++){var C=h[k];o=o||dt[C.a||0]||C.an,l=l||U(C,"pos"),c=c||U(C,"org"),f=f||U(C,"move"),d=d||U(C,"fade")||U(C,"fad"),m=U(C,"clip")||m;var I=Object.keys(C)[0];if(I&&!~ft.indexOf(I)){var L=p.tag,G=L.c1,j=L.c2,X=L.c3,re=L.c4,oe=v.fs||p.tag.fs,K=U(C,I,{start:i,end:s,c1:G,c2:j,c3:X,c4:re,fs:oe});I==="t"?(N.tag.t=N.tag.t||[],N.tag.t.push(K.t)):B(N.tag,K)}}if(v=N.tag,u!==void 0&&(g.push(p),p=Be(n[u]?u:a,n)),N.text||N.drawing){var q=p.fragments[p.fragments.length-1]||{};q.text&&N.text&&!Object.keys(N.tag).length?q.text+=N.text:p.fragments.push(N)}}return g.push(p),B({alignment:o,slices:g},l,c,f,d,m)}function mt(e){for(var n=e.styles,a=e.dialogues,r=1/0,i=[],s=0;s<a.length;s++){var o=a[s];if(!(o.Start>=o.End)){n[o.Style]||(o.Style="Default");var l=n[o.Style].style,c=pt({styles:n,name:o.Style,parsed:o.Text.parsed,start:o.Start,end:o.End}),f=c.alignment||l.Alignment;r=Math.min(r,o.Layer),i.push(B({layer:o.Layer,start:o.Start,end:o.End,margin:{left:o.MarginL||l.MarginL,right:o.MarginR||l.MarginR,vertical:o.MarginV||l.MarginV},effect:o.Effect},c,{alignment:f}))}}for(var d=0;d<i.length;d++)i[d].layer-=r;return i.sort(function(m,g){return m.start-g.start||m.end-g.end})}var ht={Name:"Default",Fontname:"Arial",Fontsize:"20",PrimaryColour:"&H00FFFFFF&",SecondaryColour:"&H000000FF&",OutlineColour:"&H00000000&",BackColour:"&H00000000&",Bold:"0",Italic:"0",Underline:"0",StrikeOut:"0",ScaleX:"100",ScaleY:"100",Spacing:"0",Angle:"0",BorderStyle:"1",Outline:"2",Shadow:"2",Alignment:"2",MarginL:"10",MarginR:"10",MarginV:"10",Encoding:"1"};function ie(e){if(/^(&|H|&H)[0-9a-f]{6,}/i.test(e)){var n=e.match(/&?H?([0-9a-f]{2})?([0-9a-f]{6})/i),a=n[1],r=n[2];return[a||"00",r]}var i=parseInt(e,10);if(!Number.isNaN(i)){var s=-2147483648,o=2147483647;if(i<s)return["00","000000"];var l=s<=i&&i<=o?("00000000"+(i<0?i+4294967296:i).toString(16)).slice(-8):String(i).slice(0,8);return[l.slice(0,2),l.slice(2)]}return["00","000000"]}function ut(e){for(var n=e.info,a=e.style,r=e.format,i=e.defaultStyle,s={},o=[B({},ht,i,{Name:"Default"})].concat(a.map(function(f){for(var d={},m=0;m<r.length;m++)d[r[m]]=f[m];return d})),l=function(f){var d=o[f];/^(\*+)Default$/.test(d.Name)&&(d.Name="Default"),Object.keys(d).forEach(function(k){k!=="Name"&&k!=="Fontname"&&!/Colour/.test(k)&&(d[k]*=1)});var m=ie(d.PrimaryColour),g=m[0],p=m[1],v=ie(d.SecondaryColour),b=v[0],y=v[1],h=ie(d.OutlineColour),S=h[0],V=h[1],u=ie(d.BackColour),w=u[0],x=u[1],N={fn:d.Fontname,fs:d.Fontsize,c1:p,a1:g,c2:y,a2:b,c3:V,a3:S,c4:x,a4:w,b:Math.abs(d.Bold),i:Math.abs(d.Italic),u:Math.abs(d.Underline),s:Math.abs(d.StrikeOut),fscx:d.ScaleX,fscy:d.ScaleY,fsp:d.Spacing,frz:d.Angle,xbord:d.Outline,ybord:d.Outline,xshad:d.Shadow,yshad:d.Shadow,q:/^[0-3]$/.test(n.WrapStyle)?n.WrapStyle*1:2};s[d.Name]={style:d,tag:N}},c=0;c<o.length;c++)l(c);return s}function vt(e,n){n===void 0&&(n={});var a=at(e),r=ut({info:a.info,style:a.styles.style,format:a.styles.format,defaultStyle:n.defaultStyle||{}});return{info:a.info,width:a.info.PlayResX*1||null,height:a.info.PlayResY*1||null,collisions:a.info.Collisions||"Normal",styles:r,dialogues:mt({styles:r,dialogues:a.events.dialogue})}}var Te=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){return setTimeout(e,50/3)},Ie=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;function D(e){var n=e.match(/(\w\w)(\w\w)(\w\w)(\w\w)/),a=1-("0x"+n[1])/255,r=+("0x"+n[2]),i=+("0x"+n[3]),s=+("0x"+n[4]);return"rgba("+s+","+i+","+r+","+a+")"}function te(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=Math.random()*16|0,a=e==="x"?n:n&3|8;return a.toString(16)})}function E(e,n){n===void 0&&(n=[]);for(var a=document.createElementNS("http://www.w3.org/2000/svg",e),r=0;r<n.length;r++){var i=n[r];a.setAttributeNS(i[0]==="xlink:href"?"http://www.w3.org/1999/xlink":null,i[0],i[1])}return a}function me(e){var n=document.body,a=n.style,r=e.replace(/^\w/,function(i){return i.toUpperCase()});return e in a?"":"webkit"+r in a?"-webkit-":"moz"+r in a?"-moz-":""}var W={transform:me("transform"),animation:me("animation"),clipPath:me("clipPath")};function Le(e){var n=e.getRootNode?e.getRootNode():document;return n===document?n.head:n}var gt=["c3","a3","c4","a4","xbord","ybord","xshad","yshad","blur","be"],Fe=["fscx","fscy","frx","fry","frz","fax","fay"];function yt(e){var n=this._.scriptRes.width,a=this._.scriptRes.height,r="";if(e.dots!==null){var i=e.dots,s=i.x1,o=i.y1,l=i.x2,c=i.y2;s/=n,o/=a,l/=n,c/=a,r="M"+s+","+o+"L"+s+","+c+","+l+","+c+","+l+","+o+"Z"}e.drawing!==null&&(r=e.drawing.instructions.map(function(g){var p=g.type,v=g.points;return p+v.map(function(b){var y=b.x,h=b.y;return y/n+","+h/a}).join(",")}).join(""));var f=1/(1<<e.scale-1);e.inverse&&(r+="M0,0L0,"+f+","+f+","+f+","+f+",0,0,0Z");var d="ASS-"+te(),m=E("clipPath",[["id",d],["clipPathUnits","objectBoundingBox"]]);return m.appendChild(E("path",[["d",r],["transform","scale("+f+")"],["clip-rule","evenodd"]])),this._.$defs.appendChild(m),{$clipPath:m,cssText:W.clipPath+"clip-path:url(#"+d+");"}}function wt(e){if(e.clip){var n=document.createElement("div");this._.$stage.insertBefore(n,e.$div),n.appendChild(e.$div),n.className="ASS-fix-objectBoundingBox";var a=yt.call(this,e.clip),r=a.cssText,i=a.$clipPath;this._.$defs.appendChild(i),n.style.cssText=r,B(e,{$div:n,$clipPath:i})}}var ne=document.createElement("div");ne.className="ASS-fix-font-size",ne.textContent="M";var he=Object.create(null);function ue(e,n){var a=e+"-"+n;return he[a]||(ne.style.cssText="line-height:normal;font-size:"+n+'px;font-family:"'+e+'",Arial;',he[a]=n*n/ne.clientHeight),he[a]}function xt(e,n,a){var r=e.xbord||e.ybord,i=e.xshad||e.yshad,s=e.a1!=="FF",o=e.blur||e.be||0,l=E("filter",[["id",n]]);l.appendChild(E("feGaussianBlur",[["stdDeviation",r?0:o],["in","SourceGraphic"],["result","sg_b"]])),l.appendChild(E("feFlood",[["flood-color",D(e.a1+e.c1)],["result","c1"]])),l.appendChild(E("feComposite",[["operator","in"],["in","c1"],["in2","sg_b"],["result","main"]])),r&&(l.appendChild(E("feMorphology",[["radius",e.xbord*a+" "+e.ybord*a],["operator","dilate"],["in","SourceGraphic"],["result","dil"]])),l.appendChild(E("feGaussianBlur",[["stdDeviation",o],["in","dil"],["result","dil_b"]])),l.appendChild(E("feComposite",[["operator","out"],["in","dil_b"],["in2","SourceGraphic"],["result","dil_b_o"]])),l.appendChild(E("feFlood",[["flood-color",D(e.a3+e.c3)],["result","c3"]])),l.appendChild(E("feComposite",[["operator","in"],["in","c3"],["in2","dil_b_o"],["result","border"]]))),i&&(r||s)&&(l.appendChild(E("feOffset",[["dx",e.xshad*a],["dy",e.yshad*a],["in",r?"dil":"SourceGraphic"],["result","off"]])),l.appendChild(E("feGaussianBlur",[["stdDeviation",o],["in","off"],["result","off_b"]])),s||(l.appendChild(E("feOffset",[["dx",e.xshad*a],["dy",e.yshad*a],["in","SourceGraphic"],["result","sg_off"]])),l.appendChild(E("feComposite",[["operator","out"],["in","off_b"],["in2","sg_off"],["result","off_b_o"]]))),l.appendChild(E("feFlood",[["flood-color",D(e.a4+e.c4)],["result","c4"]])),l.appendChild(E("feComposite",[["operator","in"],["in","c4"],["in2",s?"off_b":"off_b_o"],["result","shadow"]])));var c=E("feMerge",[]);return i&&(r||s)&&c.appendChild(E("feMergeNode",[["in","shadow"]])),r&&c.appendChild(E("feMergeNode",[["in","border"]])),c.appendChild(E("feMergeNode",[["in","main"]])),l.appendChild(c),l}function se(e,n){var a=[],r=D(e.a3+e.c3),i=e.xbord*n,s=e.ybord*n,o=D(e.a4+e.c4),l=e.xshad*n,c=e.yshad*n,f=e.blur||e.be||0;if(!(i+s+l+c))return"none";if(i||s)for(var d=-1;d<=1;d++)for(var m=-1;m<=1;m++){for(var g=1;g<i;g++)for(var p=1;p<s;p++)(d||m)&&a.push(r+" "+d*g+"px "+m*p+"px "+f+"px");a.push(r+" "+d*i+"px "+m*s+"px "+f+"px")}if(l||c){var v=l>0?1:-1,b=c>0?1:-1;l=Math.abs(l),c=Math.abs(c);for(var y=Math.max(i,l-i);y<l+i;y++)for(var h=Math.max(s,c-s);h<c+s;h++)a.push(o+" "+y*v+"px "+h*b+"px "+f+"px");a.push(o+" "+(l+i)*v+"px "+(c+s)*b+"px "+f+"px")}return a.join()}function ve(e){return["perspective(314px)","rotateY("+(e.fry||0)+"deg)","rotateX("+(e.frx||0)+"deg)","rotateZ("+(-e.frz||0)+"deg)","scale("+(e.p?1:(e.fscx||100)/100)+","+(e.p?1:(e.fscy||100)/100)+")","skew("+(e.fax||0)+"rad,"+(e.fay||0)+"rad)"].join(" ")}function bt(e){var n=e.alignment,a=e.width,r=e.height,i=e.x,s=e.y,o=e.$div,l=e.org;l||(l={x:0,y:0},n%3===1&&(l.x=i),n%3===2&&(l.x=i+a/2),n%3===0&&(l.x=i+a),n<=3&&(l.y=s+r),n>=4&&n<=6&&(l.y=s+r/2),n>=7&&(l.y=s));for(var c=o.childNodes.length-1;c>=0;c--){var f=o.childNodes[c];if(f.dataset.hasRotate==="true"){var d=l.x-i-f.offsetLeft,m=l.y-s-f.offsetTop;f.style.cssText+=W.transform+"transform-origin:"+d+"px "+m+"px;"}}}function Re(e,n){return"@"+W.animation+"keyframes "+e+" {"+n+`}
`}var ae=function(){this.obj={}};ae.prototype.set=function(n,a,r){this.obj[n]||(this.obj[n]={}),this.obj[n][a]=r},ae.prototype.setT=function(n){var a=n.t1,r=n.t2,i=n.duration,s=n.prop,o=n.from,l=n.to;this.set("0.000%",s,o),a<i&&this.set((a/i*100).toFixed(3)+"%",s,o),r<i&&this.set((r/i*100).toFixed(3)+"%",s,l),this.set("100.000%",s,l)},ae.prototype.toString=function(){var n=this;return Object.keys(this.obj).map(function(a){return a+"{"+Object.keys(n.obj[a]).map(function(r){return""+(W[r]||"")+r+":"+n.obj[a][r]+";"}).join("")+"}"}).join("")};function St(e){return e.reduceRight(function(n,a){var r=!1;return n.map(function(i){return r=a.t1===i.t1&&a.t2===i.t2&&a.accel===i.accel,B({},i,r?{tag:B({},i.tag,a.tag)}:{})}).concat(r?[]:a)},[])}function kt(){var e=this,n="";return this.dialogues.forEach(function(a){var r=a.start,i=a.end,s=a.effect,o=a.move,l=a.fade,c=a.slices,f=(i-r)*1e3,d=new ae;if(s&&!o){var m=s.name,g=s.delay,p=s.lefttoright,v=s.y1,b=s.y2||e._.resampledRes.height;if(m==="banner"){var y=e.scale*(f/g)*(p?1:-1);d.set("0.000%","transform","translateX(0)"),d.set("100.000%","transform","translateX("+y+"px)")}if(/^scroll/.test(m)){var h=/up/.test(m)?-1:1,S="translateY("+e.scale*v*h+"px)",V="translateY("+e.scale*b*h+"px)",u=(b-v)/(f/g)*100;d.set("0.000%","transform",S),u<100&&d.set(u.toFixed(3)+"%","transform",V),d.set("100.000%","transform",V)}}if(o){var w=o.x1,x=o.y1,N=o.x2,k=o.y2,C=o.t1,I=o.t2||f,L=a.pos||{x:0,y:0},G=[{x:w,y:x},{x:N,y:k}].map(function(F){var R=F.x,M=F.y;return"translate("+e.scale*(R-L.x)+"px, "+e.scale*(M-L.y)+"px)"});d.setT({t1:C,t2:I,duration:f,prop:"transform",from:G[0],to:G[1]})}if(l)if(l.type==="fad"){var j=l.t1,X=l.t2;d.set("0.000%","opacity",0),j<f?(d.set((j/f*100).toFixed(3)+"%","opacity",1),j+X<f&&d.set(((f-X)/f*100).toFixed(3)+"%","opacity",1),d.set("100.000%","opacity",0)):d.set("100.000%","opacity",f/j)}else{var re=l.a1,oe=l.a2,K=l.a3,q=l.t1,Z=l.t2,H=l.t3,He=l.t4,fe=[q,Z,H,He].map(function(F){return(F/f*100).toFixed(3)+"%"}),J=[re,oe,K].map(function(F){return 1-F/255});d.set("0.000%","opacity",J[0]),q<f&&d.set(fe[0],"opacity",J[0]),Z<f&&d.set(fe[1],"opacity",J[1]),H<f&&d.set(fe[2],"opacity",J[1]),He<f&&d.set(fe[3],"opacity",J[2]),d.set("100.000%","opacity",J[2])}var We=d.toString();We&&(B(a,{animationName:"ASS-"+te()}),n+=Re(a.animationName,We)),c.forEach(function(F){F.fragments.forEach(function(R){if(!(!R.tag.t||!R.tag.t.length)){var M=new ae,T=B({},F.tag,R.tag);St(R.tag.t).forEach(function(Ce){var Q=Ce.t1,ee=Ce.t2,_=Ce.tag;if(_.fs){var Cn=e.scale*ue(T.fn,T.fs)+"px",Nn=e.scale*ue(_.fn,T.fs)+"px";M.setT({t1:Q,t2:ee,duration:f,prop:"font-size",from:Cn,to:Nn})}if(_.fsp){var En=e.scale*T.fsp+"px",Vn=e.scale*_.fsp+"px";M.setT({t1:Q,t2:ee,duration:f,prop:"letter-spacing",from:En,to:Vn})}var Ye=_.a1!==void 0&&_.a1===_.a2&&_.a2===_.a3&&_.a3===_.a4;if(_.c1||_.a1&&!Ye){var _n=D(T.a1+T.c1),Bn=D((_.a1||T.a1)+(_.c1||T.c1));M.setT({t1:Q,t2:ee,duration:f,prop:"color",from:_n,to:Bn})}if(Ye){var Tn=1-parseInt(T.a1,16)/255,In=1-parseInt(_.a1,16)/255;M.setT({t1:Q,t2:ee,duration:f,prop:"opacity",from:Tn,to:In})}var Ln=gt.some(function(P){return _[P]!==void 0&&_[P]!==(R.tag[P]||F.tag[P])});if(Ln){var Ge=/Yes/i.test(e.info.ScaledBorderAndShadow)?e.scale:1,Fn=se(T,Ge),Rn=se(B({},T,_),Ge);M.setT({t1:Q,t2:ee,duration:f,prop:"text-shadow",from:Fn,to:Rn})}var $n=Fe.some(function(P){return _[P]!==void 0&&_[P]!==(R.tag[P]||F.tag[P])});if($n){var Xe=B({},T,_);R.drawing&&(B(Xe,{p:0,fscx:(_.fscx||T.fscx)/T.fscx*100,fscy:(_.fscy||T.fscy)/T.fscy*100}),B(T,{fscx:100,fscy:100}));var Dn=ve(T),An=ve(Xe);M.setT({t1:Q,t2:ee,duration:f,prop:"transform",from:Dn,to:An})}});var kn=M.toString();B(R,{animationName:"ASS-"+te()}),n+=Re(R.animationName,kn)}})})}),n}function $e(e,n,a){var r=W.animation;return r+"animation-name:"+e+";"+r+"animation-duration:"+n+"s;"+r+"animation-delay:"+a+"s;"+r+"animation-timing-function:linear;"+r+"animation-iteration-count:1;"+r+"animation-fill-mode:forwards;"}function Ct(e,n){var a=B({},n,e.tag),r=e.drawing,i=r.minX,s=r.minY,o=r.width,l=r.height,c=this.scale/(1<<a.p-1),f=(a.fscx?a.fscx/100:1)*c,d=(a.fscy?a.fscy/100:1)*c,m=a.blur||a.be||0,g=a.xbord+(a.xshad<0?-a.xshad:0)+m,p=a.ybord+(a.yshad<0?-a.yshad:0)+m,v=o*f+2*a.xbord+Math.abs(a.xshad)+2*m,b=l*d+2*a.ybord+Math.abs(a.yshad)+2*m,y=E("svg",[["width",v],["height",b],["viewBox",-g+" "+-p+" "+v+" "+b]]),h=/Yes/i.test(this.info.ScaledBorderAndShadow)?this.scale:1,S="ASS-"+te(),V=E("defs");V.appendChild(xt(a,S,h)),y.appendChild(V);var u="ASS-"+te(),w=E("symbol",[["id",u],["viewBox",i+" "+s+" "+o+" "+l]]);return w.appendChild(E("path",[["d",e.drawing.d]])),y.appendChild(w),y.appendChild(E("use",[["width",o*f],["height",l*d],["xlink:href","#"+u],["filter","url(#"+S+")"]])),y.style.cssText="position:absolute;left:"+(i*f-g)+"px;top:"+(s*d-p)+"px;",{$svg:y,cssText:"position:relative;width:"+o*f+"px;height:"+l*d+"px;"}}function Nt(e,n){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\s/g,"&nbsp;").replace(/\\h/g,"&nbsp;").replace(/\\N/g,"<br>").replace(/\\n/g,n===2?"<br>":"&nbsp;")}function Et(e){var n=this,a=document.createElement("div");a.className="ASS-dialogue";var r=document.createDocumentFragment(),i=e.slices,s=e.start,o=e.end;return i.forEach(function(l){var c=l.borderStyle;l.fragments.forEach(function(f){var d=f.text,m=f.drawing,g=f.animationName,p=B({},l.tag,f.tag),v="display:inline-block;",b=n.video.currentTime;if(!m){v+='font-family:"'+p.fn+'",Arial;',v+="font-size:"+n.scale*ue(p.fn,p.fs)+"px;",v+="color:"+D(p.a1+p.c1)+";";var y=/Yes/i.test(n.info.ScaledBorderAndShadow)?n.scale:1;c===1&&(v+="text-shadow:"+se(p,y)+";"),c===3&&(v+="background-color:"+D(p.a3+p.c3)+";box-shadow:"+se(p,y)+";"),v+=p.b?"font-weight:"+(p.b===1?"bold":p.b)+";":"",v+=p.i?"font-style:italic;":"",v+=p.u||p.s?"text-decoration:"+(p.u?"underline":"")+" "+(p.s?"line-through":"")+";":"",v+=p.fsp?"letter-spacing:"+p.fsp+"px;":"",(p.q===1||p.q===0||p.q===3)&&(v+="word-break:break-all;white-space:normal;"),p.q===2&&(v+="word-break:normal;white-space:nowrap;")}var h=Fe.some(function(u){return/^fsc[xy]$/.test(u)?p[u]!==100:!!p[u]});if(h&&(v+=W.transform+"transform:"+ve(p)+";",m||(v+="transform-style:preserve-3d;word-break:normal;white-space:nowrap;")),g&&(v+=$e(g,o-s,Math.min(0,s-b))),m&&p.pbo){var S=n.scale*-p.pbo*(p.fscy||100)/100;v+="vertical-align:"+S+"px;"}var V=/"fr[xyz]":[^0]/.test(JSON.stringify(p));Nt(d,p.q).split("<br>").forEach(function(u,w){var x=document.createElement("span");if(x.dataset.hasRotate=V,m){var N=Ct.call(n,f,l.tag);x.style.cssText=N.cssText,x.appendChild(N.$svg)}else{if(w&&r.appendChild(document.createElement("br")),!u)return;x.innerHTML=u}x.style.cssText+=v,r.appendChild(x)})})}),a.appendChild(r),a}function Vt(e){var n=e.layer,a=e.margin,r=e.width,i=e.height,s=e.alignment,o=e.end,l=this.width-(this.scale*(a.left+a.right)|0),c=this.height,f=this.scale*a.vertical|0,d=this.video.currentTime*100;this._.space[n]=this._.space[n]||{left:{width:new Uint16Array(c+1),end:new Uint16Array(c+1)},center:{width:new Uint16Array(c+1),end:new Uint16Array(c+1)},right:{width:new Uint16Array(c+1),end:new Uint16Array(c+1)}};var m=this._.space[n],g=["right","left","center"][s%3],p=function(w){var x=m.left.width[w],N=m.center.width[w],k=m.right.width[w],C=m.left.end[w],I=m.center.end[w],L=m.right.end[w];return g==="left"&&(C>d&&x||I>d&&N&&2*r+N>l||L>d&&k&&r+k>l)||g==="center"&&(C>d&&x&&2*x+r>l||I>d&&N||L>d&&k&&2*k+r>l)||g==="right"&&(C>d&&x&&x+r>l||I>d&&N&&2*r+N>l||L>d&&k)},v=0,b=0,y=function(w){return v=p(w)?0:v+1,v>=i?(b=w,!0):!1};if(s<=3)for(var h=c-f-1;h>f&&!y(h);h--);else if(s>=7)for(var S=f+1;S<c-f&&!y(S);S++);else for(var V=c-i>>1;V<c-f&&!y(V);V++);s>3&&(b-=i-1);for(var u=b;u<b+i;u++)m[g].width[u]=r,m[g].end[u]=o*100;return b}function _t(e){var n=e.effect,a=e.move,r=e.alignment,i=e.width,s=e.height,o=e.margin,l=e.slices,c=0,f=0;if(n)n.name==="banner"&&(r<=3&&(f=this.height-s-o.vertical),r>=4&&r<=6&&(f=(this.height-s)/2),r>=7&&(f=o.vertical),c=n.lefttoright?-i:this.width);else if(e.pos||a){var d=e.pos||{x:0,y:0};r%3===1&&(c=this.scale*d.x),r%3===2&&(c=this.scale*d.x-i/2),r%3===0&&(c=this.scale*d.x-i),r<=3&&(f=this.scale*d.y-s),r>=4&&r<=6&&(f=this.scale*d.y-s/2),r>=7&&(f=this.scale*d.y)}else{r%3===1&&(c=0),r%3===2&&(c=(this.width-i)/2),r%3===0&&(c=this.width-i-this.scale*o.right);var m=l.some(function(g){return g.fragments.some(function(p){var v=p.animationName;return v})});m?(r<=3&&(f=this.height-s-o.vertical),r>=4&&r<=6&&(f=(this.height-s)/2),r>=7&&(f=o.vertical)):f=Vt.call(this,e)}return{x:c,y:f}}function Bt(e){var n=e.layer,a=e.start,r=e.end,i=e.alignment,s=e.effect,o=e.pos,l=e.margin,c=e.animationName,f=e.width,d=e.height,m=e.x,g=e.y,p=this.video.currentTime,v="";if(n&&(v+="z-index:"+n+";"),c&&(v+=$e(c,r-a,Math.min(0,a-p))),v+="text-align:"+["right","left","center"][i%3]+";",!s){var b=this.width-this.scale*(l.left+l.right);v+="max-width:"+b+"px;",o||(i%3===1&&(v+="margin-left:"+this.scale*l.left+"px;"),i%3===0&&(v+="margin-right:"+this.scale*l.right+"px;"),f>this.width-this.scale*(l.left+l.right)&&(v+="margin-left:"+this.scale*l.left+"px;",v+="margin-right:"+this.scale*l.right+"px;"))}return v+="width:"+f+"px;height:"+d+"px;left:"+m+"px;top:"+g+"px;",v}function Tt(e){var n=Et.call(this,e);B(e,{$div:n}),this._.$stage.appendChild(n);var a=n.getBoundingClientRect(),r=a.width,i=a.height;return B(e,{width:r,height:i}),B(e,_t.call(this,e)),n.style.cssText=Bt.call(this,e),bt(e),wt.call(this,e),e}function De(){for(var e=this.video.currentTime,n=this._.stagings.length-1;n>=0;n--){var a=this._.stagings[n],r=a.end;if(a.effect&&/scroll/.test(a.effect.name)){var i=a.effect,s=i.y1,o=i.y2,l=i.delay,c=((o||this._.resampledRes.height)-s)/(1e3/l);r=Math.min(r,a.start+c)}r<e&&(this._.$stage.removeChild(a.$div),a.$clipPath&&this._.$defs.removeChild(a.$clipPath),this._.stagings.splice(n,1))}for(var f=this.dialogues;this._.index<f.length&&e>=f[this._.index].start;){if(e<f[this._.index].end){var d=Tt.call(this,f[this._.index]);this._.stagings.push(d)}++this._.index}}function Ae(){var e=this,n=function(){De.call(e),e._.requestId=Te(n)};return Ie(this._.requestId),this._.requestId=Te(n),this._.$stage.classList.remove("ASS-animation-paused"),this}function Me(){return Ie(this._.requestId),this._.requestId=0,this._.$stage.classList.add("ASS-animation-paused"),this}function Pe(){for(;this._.$stage.lastChild;)this._.$stage.removeChild(this._.$stage.lastChild);for(;this._.$defs.lastChild;)this._.$defs.removeChild(this._.$defs.lastChild);this._.stagings=[],this._.space=[]}function ge(){var e=this.video.currentTime,n=this.dialogues;Pe.call(this),this._.index=function(){for(var a=0,r=n.length-1;a+1<r&&e>n[r+a>>1].end;)a=r+a>>1;if(!a)return 0;for(var i=a;i<r;i++)if(n[i].end>e&&e>=n[i].start||i&&n[i-1].end<e&&e<n[i].start)return i;return r}(),De.call(this)}function It(){var e=this._.listener;e.play=Ae.bind(this),e.pause=Me.bind(this),e.seeking=ge.bind(this),this.video.addEventListener("play",e.play),this.video.addEventListener("pause",e.pause),this.video.addEventListener("seeking",e.seeking)}function Lt(){var e=this._.listener;this.video.removeEventListener("play",e.play),this.video.removeEventListener("pause",e.pause),this.video.removeEventListener("seeking",e.seeking),e.play=null,e.pause=null,e.seeking=null}function Ue(){var e=this.video.clientWidth,n=this.video.clientHeight,a=this.video.videoWidth||e,r=this.video.videoHeight||n,i=this._.scriptRes.width,s=this._.scriptRes.height,o=i,l=s,c=Math.min(e/a,n/r);this.resampling==="video_width"&&(l=i/a*r),this.resampling==="video_height"&&(o=s/r*a),this.scale=Math.min(e/o,n/l),this.resampling==="script_width"&&(this.scale=c*(a/o)),this.resampling==="script_height"&&(this.scale=c*(r/l)),this.width=this.scale*o,this.height=this.scale*l,this._.resampledRes={width:o,height:l},this.container.style.cssText="width:"+e+"px;height:"+n+"px;";var f="width:"+this.width+"px;height:"+this.height+"px;top:"+(n-this.height)/2+"px;left:"+(e-this.width)/2+"px;";return this._.$stage.style.cssText=f,this._.$svg.style.cssText=f,this._.$svg.setAttributeNS(null,"viewBox","0 0 "+i+" "+s),this._.$animation.innerHTML=kt.call(this),ge.call(this),this}var Ft=".ASS-container,.ASS-stage{position:relative;overflow:hidden}.ASS-container video{position:absolute;top:0;left:0}.ASS-stage{pointer-events:none;position:absolute}.ASS-dialogue{font-size:0;position:absolute}.ASS-fix-font-size{position:absolute;visibility:hidden}.ASS-fix-objectBoundingBox{width:100%;height:100%;position:absolute;top:0;left:0}.ASS-animation-paused *{-webkit-animation-play-state:paused!important;animation-play-state:paused!important}";function Rt(e,n,a){if(a===void 0&&(a={}),this.scale=1,this._={index:0,stagings:[],space:[],listener:{},$svg:E("svg"),$defs:E("defs"),$stage:document.createElement("div"),$animation:document.createElement("style")},this._.$svg.appendChild(this._.$defs),this._.$stage.className="ASS-stage ASS-animation-paused",this._.resampling=a.resampling||"video_height",this.container=a.container||document.createElement("div"),this.container.classList.add("ASS-container"),this.container.appendChild(ne),this.container.appendChild(this._.$svg),this._.hasInitContainer=!!a.container,this.video=n,It.call(this),!this._.hasInitContainer){var r=!n.paused;n.parentNode.insertBefore(this.container,n),this.container.appendChild(n),r&&n.paused&&n.play()}this.container.appendChild(this._.$stage);var i=vt(e),s=i.info,o=i.width,l=i.height,c=i.dialogues;this.info=s,this._.scriptRes={width:o||n.videoWidth,height:l||n.videoHeight},this.dialogues=c;var f=Le(this.container),d=f.querySelector("#ASS-global-style");return d||(d=document.createElement("style"),d.type="text/css",d.id="ASS-global-style",d.appendChild(document.createTextNode(Ft)),f.appendChild(d)),this._.$animation.type="text/css",this._.$animation.className="ASS-animation",f.appendChild(this._.$animation),Ue.call(this),this.video.paused||(ge.call(this),Ae.call(this)),this}function $t(){return this._.$stage.style.visibility="visible",this}function Dt(){return this._.$stage.style.visibility="hidden",this}function At(){Me.call(this),Pe.call(this),Lt.call(this,this._.listener);var e=Le(this.container);if(!this._.hasInitContainer){var n=!this.video.paused;this.container.parentNode.insertBefore(this.video,this.container),this.container.parentNode.removeChild(this.container),n&&this.video.paused&&this.video.play()}e.removeChild(this._.$animation);for(var a in this)Object.prototype.hasOwnProperty.call(this,a)&&(this[a]=null);return this}var Oe=/^(video|script)_(width|height)$/;function Mt(){return Oe.test(this._.resampling)?this._.resampling:"video_height"}function Pt(e){return e===this._.resampling?e:(Oe.test(e)&&(this._.resampling=e,this.resize()),this._.resampling)}var Y=function(n,a,r){return typeof n!="string"?this:Rt.call(this,n,a,r)},ye={resampling:{configurable:!0}};Y.prototype.resize=function(){return Ue.call(this)},Y.prototype.show=function(){return $t.call(this)},Y.prototype.hide=function(){return Dt.call(this)},Y.prototype.destroy=function(){return At.call(this)},ye.resampling.get=function(){return Mt.call(this)},ye.resampling.set=function(e){return Pt.call(this,e)},Object.defineProperties(Y.prototype,ye);const Ut=t.defineComponent({name:"SubtitleSelector"}),Ot=t.defineComponent({...Ut,props:{subtitleList:{type:Array,default:()=>[]}},setup(e){const n=e;return(a,r)=>{const i=t.resolveComponent("v-radio"),s=t.resolveComponent("v-radio-group");return t.openBlock(),t.createBlock(s,null,{default:t.withCtx(()=>[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(n.subtitleList,(o,l)=>(t.openBlock(),t.createBlock(i,{key:l,color:"primary",label:o.title,value:o},null,8,["label","value"]))),128))]),_:1})}}});var A;(e=>{function n(){return{url:"/video/getFFMpegInfo"}}e.getFFMpegInfo=n;function a(c){return{url:"/video/encodeConvert",data:c,method:"post",headers:{"Content-Type":"application/json"}}}e.encodeConvert=a;function r(){return{url:"/video/check"}}e.check=r;function i(c,f,d,m){return{url:"/video/listConvertTask",params:{uid:c,status:f,page:d,pageSize:m}}}e.listConvertTask=i;function s(c){return{url:"/video/getLog",params:{taskId:c}}}e.getLog=s;function o(c,f,d){return{url:"/video/recordWatchProgress",params:{uid:c,identify:f,time:d},method:"post"}}e.recordWatchProgress=o;function l(c,f){return{url:"/video/getWatchProgress",params:{uid:c,identify:f}}}e.getWatchProgress=l})(A||(A={}));const zt=t.defineComponent({name:"VideoEnhancePlayer"}),jt=t.defineComponent({...zt,props:{url:{type:String,default:void 0},videoInfo:{type:Object,default:void 0},subtitleList:{type:Array,default:()=>[]},file:{type:Object,default:void 0}},setup(e){const n=window.SfcUtils,a=e,r=t.ref(),i=t.ref();let s,o,l;const c=async u=>{const w=s.video.currentTime;s.destroy(),s=new window.DPlayer(u),p(s),s.play(),s.seek(w)},f=$.MethodInterceptor.createThrottleProxy({autoResizeAss(){o&&o.resize()}},{afterExecute:!0,delay:500});function d(){l&&(clearInterval(l),l=null)}function m(u){o&&(o.destroy(),o=null);const w=document.createElement("div");w.classList.add("subtitle");const x=i.value.getAttributeNames().find(C=>C.startsWith("data-v-"));w.setAttribute(x,""),i.value.appendChild(w),o=new Y(u,s.video,{container:w,resampling:"video_width"}),d();const N="21px",k=i.value.querySelector(".ASS-stage");if(k&&k.getAttribute("has-hock-append-child")!="1"){k.setAttribute("has-hock-append-child","1");const C=k.appendChild.bind(k);k.appendChild=I=>{if(I instanceof HTMLElement){const L=I.querySelector("span");L&&(L.style.fontSize=N)}return C(I)}}l=setInterval(()=>{i.value.querySelectorAll(".ASS-stage span").forEach(C=>C.style.fontSize=N)},500)}const g=()=>{if(!a.url)return;const u={container:i.value,video:{url:a.url}},w=t.ref();a.videoInfo&&(a.subtitleList.length&&(window.SfcUtils.snackbar(`检测到${a.subtitleList.length}个字幕`),u.contextmenu=[{text:"选择字幕",click(){window.SfcUtils.openComponentDialog(Ot,{props:t.reactive({subtitleList:a.subtitleList,"onUpdate:modelValue"(x){w.value=x},modelValue:w}),title:"选择字幕",contentMaxHeight:"360px",async onConfirm(){if(w.value.type=="webvtt")u.subtitle={url:w.value.url,fontSize:"21px"},u.contextmenu[0].text="字幕："+w.value.title,c(u),d();else{u.subtitle=void 0,u.contextmenu[0].text="字幕："+w.value.title,c(u);const x=(await n.request({url:w.value.url})).data;m(x)}return!0}})}}]),a.videoInfo.chapters.length&&(u.highlight=a.videoInfo.chapters.map(x=>({text:x.title,time:Number(x.startTime)})))),s=new window.DPlayer(u),p(s),s.play(),s.video.addEventListener("loadeddata",async()=>{const x=await V();x&&(n.snackbar(`已自动定位到${y(x)}`),s.seek(x))})};function p(u){u.video.addEventListener("timeupdate",$.MethodInterceptor.createThrottleProxy($.MethodInterceptor.wrapFun(()=>S(u.video.currentTime)),{delay:5e3}).invoke),u.video.addEventListener("seeked",()=>S(u.video.currentTime))}function v(u){return u<10?`0${u}`:u}let b=null;function y(u){const w=Math.floor(u/3600),x=Math.floor(u/60),N=Math.floor(u%60);return w?`${v(w)}:${v(x)}:${v(N)}`:`${v(x)}:${v(N)}`}function h(){var u,w;return((u=a.file)==null?void 0:u.md5)||((w=a.file)==null?void 0:w.id)||a.url}function S(u){const w=$.getContext().session.value.user.id,x=h();if(w){if(b)return;b=n.request(A.recordWatchProgress(w,x,u)).then(()=>b=null)}localStorage.setItem(`watchRecord_${w}`,String(u))}async function V(){const u=$.getContext().session.value.user.id,w=h();if(u)return(await n.request(A.getWatchProgress(u,w))).data.data;const x=localStorage.getItem(`watchRecord_${u}`);if(x)return Number(x)}return t.onMounted(async()=>{await t.nextTick(),g(),window.addEventListener("resize",f.autoResizeAss)}),t.onUnmounted(()=>{window.removeEventListener("resize",f.autoResizeAss),d()}),t.watch(()=>a.url,g),(u,w)=>(t.openBlock(),t.createElementBlock("div",{ref_key:"rootRef",ref:r,class:"player-root"},[t.createElementVNode("div",{ref_key:"playerRef",ref:i,class:"player"},w[0]||(w[0]=[t.createElementVNode("h1",null,"播放加载失败了QAQ",-1)]),512)],512))}}),qt=((e,n)=>{const a=e.__vccOpts||e;for(const[r,i]of n)a[r]=i;return a})(jt,[["__scopeId","data-v-75e220e0"]]),Ht=t.defineComponent({name:"ConfigureInfo"}),Wt=t.defineComponent({...Ht,props:{modelValue:{type:String,default:""}},setup(e){const n=e,a=()=>{window.SfcUtils.alert(n.modelValue,"编译参数")};return(r,i)=>(t.openBlock(),t.createElementBlock("a",{class:"link",onClick:a},"查看编译参数"))}}),Yt={class:"break-text"},Gt=t.defineComponent({name:"EncoderInfoList"}),ze=t.defineComponent({...Gt,props:{modelValue:{type:Array,default:()=>[]}},setup(e){return(n,a)=>{const r=t.resolveComponent("VTable"),i=t.resolveComponent("EmptyTip");return e.modelValue&&e.modelValue.length?(t.openBlock(),t.createBlock(r,{key:0},{default:t.withCtx(()=>[a[0]||(a[0]=t.createElementVNode("thead",null,[t.createElementVNode("tr",null,[t.createElementVNode("th",{style:{width:"90px"}}," 编码器 "),t.createElementVNode("th",null,"描述")])],-1)),t.createElementVNode("tbody",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(e.modelValue,s=>(t.openBlock(),t.createElementBlock("tr",{key:s.name},[t.createElementVNode("td",Yt,t.toDisplayString(s.name),1),t.createElementVNode("td",null,t.toDisplayString(s.describe),1)]))),128))])]),_:1})):(t.openBlock(),t.createBlock(i,{key:1}))}}}),Xt=t.defineComponent({name:"EncoderInfo"}),Kt=t.defineComponent({...Xt,props:{modelValue:{type:Array,default:()=>[]}},setup(e){const n=e,a=()=>{window.SfcUtils.openComponentDialog(ze,{props:{modelValue:n.modelValue},title:"编码器详情"})};return(r,i)=>(t.openBlock(),t.createElementBlock("a",{class:"link",onClick:a},"查看详情("+t.toDisplayString(e.modelValue.length)+"个)",1))}}),Zt=t.defineComponent({name:"VideoEnhanceCheck"}),je=t.defineComponent({...Zt,setup(e){const n=window.SfcUtils,a=async()=>{const r=window.SfcUtils.loadingDialog({msg:"检查中..."});try{await n.request(A.check()),r.close(),await n.sleep(250),await n.alert("配置正确")}catch(i){r.close(),await n.sleep(250),n.alert(""+i,"配置错误")}};return(r,i)=>{const s=t.resolveComponent("VBtn");return t.openBlock(),t.createElementBlock("div",null,[t.createVNode(s,{onClick:a},{default:t.withCtx(()=>i[0]||(i[0]=[t.createTextVNode(" 检查 ")])),_:1})])}}});window.bootContext.addProcessor({taskName:"注册组件",execute(e,n){e.component("ConfigureInfo",Wt),e.component("EncoderInfo",Kt),e.component("EncoderInfoList",ze),e.component(je.name,je)}});function we(e){return e<10?"0"+e:""+e}var le;(e=>{function n(r){return r<1e3?r+"bps":r<1e6?(Number(r)/1e3).toFixed(2)+"Kbps":r<1e9?(Number(r)/1e6).toFixed(2)+"Mbps":r}e.formatBitRate=n;function a(r){const i=Number(r),s=we(Math.floor(i/3600)),o=we(Math.floor(i/60%60)),l=we(Math.floor(i%60));return`${s}:${o}:${l}`}e.formatDuration=a})(le||(le={}));const Jt={key:0},Qt=t.defineComponent({name:"VideoInfo"}),en=t.defineComponent({...Qt,props:{videoInfo:{type:Object,default:()=>({})},file:{type:Object,default:void 0}},setup(e){const n=e,a=t.ref(!1),r=t.computed(()=>n.videoInfo.streams.filter(s=>s.codecType=="video")),i=t.computed(()=>n.videoInfo.streams.filter(s=>s.codecType=="audio"));return(s,o)=>{const l=t.resolveComponent("VTable");return t.openBlock(),t.createElementBlock("div",null,[o[9]||(o[9]=t.createElementVNode("div",{class:"text-title"}," 基本信息 ",-1)),t.createVNode(l,null,{default:t.withCtx(()=>[t.createElementVNode("tbody",null,[t.createElementVNode("tr",null,[o[1]||(o[1]=t.createElementVNode("td",{style:{"min-width":"160px"}}," 封装格式 ",-1)),t.createElementVNode("td",null,t.toDisplayString(e.videoInfo.format.formatName),1)]),t.createElementVNode("tr",null,[o[2]||(o[2]=t.createElementVNode("td",null,"封装格式全称",-1)),t.createElementVNode("td",null,t.toDisplayString(e.videoInfo.format.formatLongName),1)]),t.createElementVNode("tr",null,[o[3]||(o[3]=t.createElementVNode("td",null,"码率",-1)),t.createElementVNode("td",null,t.toDisplayString(t.unref(le).formatBitRate(e.videoInfo.format.bitRate))+" ("+t.toDisplayString(e.videoInfo.format.bitRate)+")",1)]),t.createElementVNode("tr",null,[o[4]||(o[4]=t.createElementVNode("td",null,"持续时长",-1)),t.createElementVNode("td",null,t.toDisplayString(t.unref(le).formatDuration(e.videoInfo.format.duration)),1)]),e.videoInfo.format.tags?(t.openBlock(),t.createElementBlock("tr",Jt,[o[6]||(o[6]=t.createElementVNode("td",null,"其他标记",-1)),t.createElementVNode("td",null,[a.value?(t.openBlock(),t.createBlock(l,{key:0},{default:t.withCtx(()=>[o[5]||(o[5]=t.createElementVNode("thead",null,[t.createElementVNode("tr",null,[t.createElementVNode("th",null,"名称"),t.createElementVNode("th",null,"值")])],-1)),t.createElementVNode("tbody",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(Object.keys(e.videoInfo.format.tags),c=>(t.openBlock(),t.createElementBlock("tr",{key:c},[t.createElementVNode("td",null,t.toDisplayString(c),1),t.createElementVNode("td",null,t.toDisplayString(e.videoInfo.format.tags[c]),1)]))),128))])]),_:1})):t.createCommentVNode("",!0),t.createElementVNode("a",{class:"link",onClick:o[0]||(o[0]=c=>a.value=!a.value)},t.toDisplayString(a.value?"收起":"展开"),1)])])):t.createCommentVNode("",!0)])]),_:1}),o[10]||(o[10]=t.createElementVNode("div",{class:"text-title"}," 视频流 ",-1)),t.createVNode(l,null,{default:t.withCtx(()=>[o[7]||(o[7]=t.createElementVNode("thead",null,[t.createElementVNode("tr",null,[t.createElementVNode("th",null,"编码"),t.createElementVNode("th",null,"分辨率"),t.createElementVNode("th",null,"帧率"),t.createElementVNode("th",null,"语言")])],-1)),t.createElementVNode("tbody",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(r.value,c=>(t.openBlock(),t.createElementBlock("tr",{key:c.index},[t.createElementVNode("td",null,t.toDisplayString(c.codecName),1),t.createElementVNode("td",null,t.toDisplayString(c.width)+"x"+t.toDisplayString(c.height),1),t.createElementVNode("td",null,t.toDisplayString((c.avgFrameRate||0).toFixed(3)),1),t.createElementVNode("td",null,t.toDisplayString(c.language||"-"),1)]))),128))])]),_:1}),o[11]||(o[11]=t.createElementVNode("div",{class:"text-title"}," 音频流 ",-1)),t.createVNode(l,null,{default:t.withCtx(()=>[o[8]||(o[8]=t.createElementVNode("thead",null,[t.createElementVNode("tr",null,[t.createElementVNode("th",null,"编码"),t.createElementVNode("th",null,"采样"),t.createElementVNode("th",null,"码率"),t.createElementVNode("th",null,"声道"),t.createElementVNode("th",null,"语言")])],-1)),t.createElementVNode("tbody",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(i.value,c=>(t.openBlock(),t.createElementBlock("tr",{key:c.index},[t.createElementVNode("td",null,t.toDisplayString(c.codecName),1),t.createElementVNode("td",null,t.toDisplayString(c.sampleRate/1e3)+"kHz",1),t.createElementVNode("td",null,t.toDisplayString(c.bitRate/1e3)+"K",1),t.createElementVNode("td",null,t.toDisplayString(c.channels),1),t.createElementVNode("td",null,t.toDisplayString(c.language||"-"),1)]))),128))])]),_:1})])}}}),tn=t.defineComponent({name:"VideoConvertForm"}),nn=t.defineComponent({...tn,props:{videoInfo:{type:Object,default:()=>({})}},emits:["submit"],setup(e,{expose:n,emit:a}){const r=t.ref(),i=e,s=t.ref(),o={title:"复制",value:"copy"},l=window.FormUtils.defineForm({actions:{async submit(){if(!i.videoInfo.streams.find(S=>(S.codecType=="audio"||S.codecType=="video")&&c.mapStreams[S.index]))throw new Error("至少选择一个音频或视频流");i.videoInfo.streams.find(S=>S.codecType=="video"&&c.mapStreams[S.index])||await window.SfcUtils.confirm("没有选择视频流，确定？","提示",{cancelToReject:!0}),i.videoInfo.streams.find(S=>S.codecType=="audio"&&c.mapStreams[S.index])||await window.SfcUtils.confirm("没有选择音频流，确定？","提示",{cancelToReject:!0}),p()},async loadFFMpegInfo(){g.beginLoading();try{const h=(await window.SfcUtils.request(A.getFFMpegInfo())).data.data;s.value=h,y.video=[o].concat(h.videoEncoders.filter(S=>S.name.includes("264")||S.name.includes("265")||S.name.includes("hevc")).map(S=>({title:S.name,value:S.name}))),y.audio=[o].concat(h.audioEncoders.filter(S=>S.name.includes("aac")).map(S=>({title:S.name,value:S.name}))),y.subtitle=[o].concat(h.subtitleEncoders.map(S=>({title:S.name,value:S.name})))}catch(h){window.SfcUtils.snackbar(h)}finally{g.closeLoading()}}},formData:{convertRules:{},mapStreams:{},enabledConvertRules:[]},formRef:r,validators:{},throwError:!0}),{formData:c,actions:f,validators:d,loadingRef:m,loadingManager:g}=l,p=()=>{c.enabledConvertRules=i.videoInfo.streams.filter(h=>c.mapStreams[h.index]).map(h=>c.convertRules[h.index]),c.enabledConvertRules.forEach(h=>{h.encoder!="copy"?h.method="convert":h.method="copy"})};i.videoInfo.streams.forEach(h=>{c.convertRules[h.index]={index:h.index,encoder:"copy",method:"copy",type:h.codecType},c.mapStreams[h.index]=!0}),p(),t.onMounted(async()=>{await f.loadFFMpegInfo()});const v=t.computed(()=>i.videoInfo.streams.filter(h=>h.codecType=="video")),b=t.computed(()=>i.videoInfo.streams.filter(h=>h.codecType=="audio"));t.computed(()=>i.videoInfo.streams.filter(h=>h.codecType=="subtitle"));const y=t.reactive({video:[],audio:[],subtitle:[]});return n(l),(h,S)=>{const V=t.resolveComponent("LoadingMask"),u=t.resolveComponent("VCheckbox"),w=t.resolveComponent("FormSelect"),x=t.resolveComponent("VTable"),N=t.resolveComponent("base-form");return t.openBlock(),t.createBlock(N,{ref_key:"formRef",ref:r,"model-value":t.unref(c),"submit-action":t.unref(f).submit},{default:t.withCtx(()=>[t.createVNode(V,{loading:t.unref(m)},null,8,["loading"]),S[2]||(S[2]=t.createElementVNode("div",{class:"text-h6"}," 视频 ",-1)),t.createVNode(x,null,{default:t.withCtx(()=>[S[0]||(S[0]=t.createElementVNode("thead",null,[t.createElementVNode("tr",null,[t.createElementVNode("th",{style:{width:"64px"}}," 选择 "),t.createElementVNode("th",null,"原编码"),t.createElementVNode("th",null,"语言"),t.createElementVNode("th",null,"编码器")])],-1)),t.createElementVNode("tbody",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(v.value,k=>(t.openBlock(),t.createElementBlock("tr",{key:k.index},[t.createElementVNode("td",null,[t.createVNode(u,{modelValue:t.unref(c).mapStreams[k.index],"onUpdate:modelValue":C=>t.unref(c).mapStreams[k.index]=C,color:"primary",style:{"margin-top":"6px"},density:"comfortable","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])]),t.createElementVNode("td",null,t.toDisplayString(k.codecName),1),t.createElementVNode("td",null,t.toDisplayString(k.language||"-"),1),t.createElementVNode("td",null,[y.video.length?(t.openBlock(),t.createBlock(w,{key:0,modelValue:t.unref(c).convertRules[k.index].encoder,"onUpdate:modelValue":C=>t.unref(c).convertRules[k.index].encoder=C,disabled:!t.unref(c).mapStreams[k.index],style:{width:"160px"},items:y.video,onChange:p},null,8,["modelValue","onUpdate:modelValue","disabled","items"])):t.createCommentVNode("",!0)])]))),128))])]),_:1}),S[3]||(S[3]=t.createElementVNode("div",{class:"text-h6"}," 音频 ",-1)),t.createVNode(x,null,{default:t.withCtx(()=>[S[1]||(S[1]=t.createElementVNode("thead",null,[t.createElementVNode("tr",null,[t.createElementVNode("th",{style:{width:"64px"}}," 选择 "),t.createElementVNode("th",null,"原编码"),t.createElementVNode("th",null,"语言"),t.createElementVNode("th",null,"编码器")])],-1)),t.createElementVNode("tbody",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(b.value,k=>(t.openBlock(),t.createElementBlock("tr",{key:k.index},[t.createElementVNode("td",null,[t.createVNode(u,{modelValue:t.unref(c).mapStreams[k.index],"onUpdate:modelValue":C=>t.unref(c).mapStreams[k.index]=C,color:"primary",style:{"margin-top":"6px"},density:"comfortable","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])]),t.createElementVNode("td",null,t.toDisplayString(k.codecName),1),t.createElementVNode("td",null,t.toDisplayString(k.language||"-"),1),t.createElementVNode("td",null,[y.audio.length?(t.openBlock(),t.createBlock(w,{key:0,modelValue:t.unref(c).convertRules[k.index].encoder,"onUpdate:modelValue":C=>t.unref(c).convertRules[k.index].encoder=C,disabled:!t.unref(c).mapStreams[k.index],style:{width:"160px"},items:y.audio,onChange:p},null,8,["modelValue","onUpdate:modelValue","disabled","items"])):t.createCommentVNode("",!0)])]))),128))])]),_:1})]),_:1},8,["model-value","submit-action"])}}}),an={style:{padding:"16px"}},rn={class:"d-flex align-center"},on={style:{padding:"0 8px",flex:"1"}},sn={class:"break-text"},ln={class:"tip",style:{"line-height":"16px"}},cn={key:0},dn={key:1},fn={key:2},pn={key:3},mn={key:0,class:"break-text"},hn={class:"min-width: 64px"},un=t.defineComponent({name:"EncodeConvertTaskInfo"}),ce=t.defineComponent({...un,props:{task:{type:Object,default(){return{}}},haveLog:{type:Boolean,default:!1},showCancel:{type:Boolean,default:!1}},setup(e){const n=e,a=t.computed(()=>JSON.parse(n.task.params||"{}")),r=window.StringFormatter.toDate,i=async()=>{const o=window.SfcUtils.loadingDialog();try{const l=(await window.SfcUtils.request(A.getLog(n.task.asyncTaskRecord.id))).data.data;l?window.SfcUtils.openComponentDialog(window.components.CodeEditor,{props:{modelValue:l.taskLog,readOnly:!0,useMiniMap:!0,style:{height:"100%"}},fullscreen:!0}):window.SfcUtils.alert("没能查询到日志")}catch(l){window.SfcUtils.alert(l,"错误")}finally{o.close()}},s=async()=>{const o=window.SfcUtils.loadingDialog({msg:"请求中..."});try{await window.SfcUtils.sleep(150),await window.SfcUtils.request(window.API.asyncTask.interrupt(n.task.asyncTaskRecord.id)),o.close()}catch(l){o.close(),await window.SfcUtils.sleep(250),window.SfcUtils.alert("请求失败: "+l)}};return(o,l)=>{var m,g;const c=t.resolveComponent("FileIcon"),f=t.resolveComponent("VProgressLinear"),d=t.resolveComponent("CommonIcon");return t.openBlock(),t.createElementBlock("div",an,[t.createElementVNode("div",rn,[t.createElementVNode("div",null,[t.createVNode(c,{width:"36","file-name":"aaa.mp4"})]),t.createElementVNode("div",on,[t.createElementVNode("div",sn,[t.createElementVNode("div",null,t.toDisplayString((g=(m=a.value)==null?void 0:m.source)==null?void 0:g.name),1),t.createElementVNode("div",ln,[e.task.asyncTaskRecord.executeDate?(t.openBlock(),t.createElementBlock("div",cn," 执行日期: "+t.toDisplayString(t.unref(r)(e.task.asyncTaskRecord.executeDate)),1)):t.createCommentVNode("",!0),e.task.asyncTaskRecord.finishDate?(t.openBlock(),t.createElementBlock("div",dn," 完成日期: "+t.toDisplayString(t.unref(r)(e.task.asyncTaskRecord.finishDate)),1)):t.createCommentVNode("",!0),e.task.asyncTaskRecord.failedDate?(t.openBlock(),t.createElementBlock("div",fn," 失败日期: "+t.toDisplayString(t.unref(r)(e.task.asyncTaskRecord.failedDate)),1)):t.createCommentVNode("",!0),e.task.asyncTaskRecord.executeDate?t.createCommentVNode("",!0):(t.openBlock(),t.createElementBlock("div",pn,t.toDisplayString(e.task.asyncTaskRecord.status==4?"已取消":"等待中"),1))])]),e.task.progress?(t.openBlock(),t.createElementBlock("div",mn,[t.createVNode(f,{color:"primary","model-value":e.task.progress.loaded,max:e.task.progress.total},null,8,["model-value","max"])])):t.createCommentVNode("",!0)]),t.createElementVNode("div",hn,[t.createElementVNode("div",{class:"text-center link",onClick:i},[t.createElementVNode("div",null,[t.createVNode(d,{color:"primary",icon:"mdi-eye"})]),l[0]||(l[0]=t.createElementVNode("div",null,[t.createElementVNode("a",{style:{"font-size":"9px"}},"查看日志")],-1))]),e.showCancel?(t.openBlock(),t.createElementBlock("div",{key:0,class:"text-center link",style:{"margin-left":"12px"},onClick:s},[t.createElementVNode("div",null,[t.createVNode(d,{color:"primary",icon:"mdi-close"})]),l[1]||(l[1]=t.createElementVNode("div",null,[t.createElementVNode("a",{style:{"font-size":"9px"}},"取消")],-1))])):t.createCommentVNode("",!0)])])])}}}),vn={key:0},gn={key:0},yn=t.defineComponent({name:"EncodeConvertTask",components:{EncodeConvertTaskInfo:ce}}),wn=t.defineComponent({...yn,props:{uid:{type:[String,Number],default:0}},setup(e){const n=t.ref("1"),a=e,r=t.ref(0),i=t.ref([]),s=t.ref([]),o=t.ref(0),l=t.ref([]),c=t.ref(0),f=async b=>(await window.SfcUtils.request(A.listConvertTask(a.uid,b,0,20))).data.data,d=async()=>{const b=f(1),y=f(0),h=await Promise.all([b,y]);r.value=Number(h[0].totalCount)||0,i.value=h[0].content,r.value+=Number(h[1].totalCount),i.value=i.value.concat(h[1].content)},m=async()=>{const b=await f(2);o.value=b.totalCount,s.value=b.content},g=async()=>{const b=await Promise.all([f(3),f(4)]);c.value=Number(b[0].totalCount)+Number(b[1].totalCount),l.value=(b[0].content||[]).concat(b[1].content)};let p,v=!1;return t.onMounted(()=>{m(),d(),g(),p=setInterval(async()=>{if(!v)try{v=!0;let b;n.value=="1"?b=d():n.value=="2"?b=m():b=g(),await b}finally{v=!1}},2500)}),t.onUnmounted(()=>{p&&clearInterval(p)}),(b,y)=>{const h=t.resolveComponent("v-tab"),S=t.resolveComponent("v-tabs"),V=t.resolveComponent("EmptyTip"),u=t.resolveComponent("v-window-item"),w=t.resolveComponent("v-window");return t.openBlock(),t.createElementBlock("div",null,[t.createVNode(S,{modelValue:n.value,"onUpdate:modelValue":y[0]||(y[0]=x=>n.value=x),color:"primary","fixed-tabs":""},{default:t.withCtx(()=>[t.createVNode(h,{value:"1"},{default:t.withCtx(()=>[y[2]||(y[2]=t.createTextVNode(" 进行中")),t.createElementVNode("span",null,"("+t.toDisplayString(r.value)+")",1)]),_:1}),t.createVNode(h,{value:"2"},{default:t.withCtx(()=>[y[3]||(y[3]=t.createTextVNode(" 已完成")),o.value?(t.openBlock(),t.createElementBlock("span",vn,"("+t.toDisplayString(o.value)+")",1)):t.createCommentVNode("",!0)]),_:1}),t.createVNode(h,{value:"3"},{default:t.withCtx(()=>[y[4]||(y[4]=t.createTextVNode(" 执行失败")),c.value?(t.openBlock(),t.createElementBlock("span",gn,"("+t.toDisplayString(c.value)+")",1)):t.createCommentVNode("",!0)]),_:1})]),_:1},8,["modelValue"]),t.createVNode(w,{modelValue:n.value,"onUpdate:modelValue":y[1]||(y[1]=x=>n.value=x)},{default:t.withCtx(()=>[t.createVNode(u,{value:"1"},{default:t.withCtx(()=>[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(i.value,x=>(t.openBlock(),t.createBlock(ce,{key:x.id,task:x,"show-cancel":""},null,8,["task"]))),128)),i.value.length?t.createCommentVNode("",!0):(t.openBlock(),t.createBlock(V,{key:0}))]),_:1}),t.createVNode(u,{value:"2"},{default:t.withCtx(()=>[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(s.value,x=>(t.openBlock(),t.createBlock(ce,{key:x.id,task:x,"have-log":!0},null,8,["task"]))),128)),s.value.length?t.createCommentVNode("",!0):(t.openBlock(),t.createBlock(V,{key:0}))]),_:1}),t.createVNode(u,{value:"3"},{default:t.withCtx(()=>[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(l.value,x=>(t.openBlock(),t.createBlock(ce,{key:x.id,task:x,"have-log":!0},null,8,["task"]))),128)),l.value.length?t.createCommentVNode("",!0):(t.openBlock(),t.createBlock(V,{key:0}))]),_:1})]),_:1},8,["modelValue"])])}}}),O=window.context,z=window.SfcUtils;function xn(e,n,a,r){if(!n.name.endsWith(".mkv"))return null;const i={name:n.name,path:a,protocol:"subtitle",targetId:e.uid,stream:r};if(e.protocol=="main")return window.SfcUtils.getApiUrl(window.API.resource.getCommonResource(i));const s=e.getProtocolParams();return i.sourceProtocol=e.protocol,i.sourceId=s.id,Object.keys(s).filter(o=>o!="id").forEach(o=>{i[o]=s[o]}),window.SfcUtils.getApiUrl(window.API.resource.getCommonResource(i))}async function xe(e,n,a){const r={name:n.name,path:a,targetId:e.uid,sourceProtocol:e.protocol||"main",protocol:e.protocol||"main"},i=e.getProtocolParams();return r.sourceId=i.id,Object.keys(i).filter(s=>s!="id").forEach(s=>{r[s]=i[s]}),r}async function be(e,n,a){const r=await xe(e,n,a);return r.protocol="videoInfo",(await await z.request(window.API.resource.getCommonResource(r))).data}const bn=new Set(["mp4","mkv","avi","rm","rmvb","m4v","flv","mpg","mpeg","mpe","ts"]);function Se(e){const n=e.split(".").pop();return!!n&&bn.has(n)}const de=O.fileOpenHandler.value.findIndex(e=>e.id=="play-video"),ke=de==-1?null:O.fileOpenHandler.value[de],qe={id:"player",icon:"mdi-play-circle",matcher(e,n){return Se(n.name)},title:"播放视频",async action(e,n){try{let a=n.path;a||(a=(await z.request(window.API.resource.parseNodeId(n.uid,n.node))).data.data),z.beginLoading(),await window.SfcUtils.sleep(100);let r;try{r=await be(e,n,a)}catch(o){console.error(o),r={chapters:[],format:{},streams:[]}}const i=[],s=n.name.lastIndexOf(".");if(s!=-1){const o=n.name.substring(0,s),l=["ass","vtt"].map(f=>`${o}.${f}`),c=e.fileList.filter(f=>l.find(d=>d==f.name)).forEach(f=>{const d=e.getFileUrl(f);d&&i.push({title:`[外挂字幕] ${f.name}`,url:d,type:f.name.endsWith(".ass")?"ass":"webvtt"})})}r.streams.filter(o=>o.codecType=="subtitle").forEach(o=>{i.push({title:`${o.language}${o.title?"("+o.title+")":""}`,url:xn(e,n,a,o.index),type:"webvtt"})}),z.openComponentDialog(qt,{props:{url:e.getFileUrl(n),videoInfo:r,subtitleList:i,file:n},dense:!0,showCancel:!1,title:"视频预览："+n.name,extraDialogOptions:{maxWidth:"80%"}})}catch(a){ke&&ke.matcher(e,n)?(z.snackbar(`增强版播放器播放失败, 改用通用版本。原因: ${a}`),ke.action(e,n)):z.snackbar(a)}finally{z.closeLoading()}},sort:0},Sn={id:"video",name:"视频",items:[{title:"视频转码",id:"video-convert",icon:"mdi-cached",renderOn(e){return e&&e.selectFileList.length==1&&!e.selectFileList[0].mount&&Se(e.selectFileList[0].name)&&!e.readonly},async action(e){const n=e.selectFileList[0],a=await be(e,n,n.path),r=window.SfcUtils.openComponentDialog(nn,{props:{videoInfo:a},title:`视频转码：${e.selectFileList[0].name}`,async onConfirm(){const i=window.SfcUtils.loadingDialog({msg:"任务创建中"});try{if((await r.getInstAsForm().submit()).success){const o=r.getInstAsForm().getFormData().enabledConvertRules,l=await xe(e,n,n.path),c=await xe(e,n,n.path);return c.name="convert_"+c.name,await window.SfcUtils.request(A.encodeConvert({rules:o,source:l,target:c})),window.SfcUtils.snackbar("任务创建成功"),!0}else return!1}catch(s){return z.snackbar(s),!1}finally{i.close()}}})}},{title:"视频信息",id:"video-info",renderOn(e){return e&&e.selectFileList.length==1&&!e.selectFileList[0].mount&&Se(e.selectFileList[0].name)},icon:"mdi-information-variant",async action(e){const n=await be(e,e.selectFileList[0],e.selectFileList[0].path);window.SfcUtils.openComponentDialog(en,{props:{videoInfo:n},title:`媒体信息：${e.selectFileList[0].name}`})}}]};O.menu.value.boxMenu.push({name:"视频服务",id:"video",items:[{id:"encoder-convert",title:"视频转码",icon:"mdi-cached",renderOn(){return!!O.session.value.token},action(e){e.title="视频转码",e.currentComponent=t.h(wn,{style:{maxWidth:"640px",margin:"auto"},uid:O.session.value.user.id})}}]}),de!=-1?O.fileOpenHandler.value[de]=qe:O.fileOpenHandler.value.push(qe),O.menu.value.fileListMenu.push(Sn)});
